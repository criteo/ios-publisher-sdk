# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

project_dir = "CriteoPublisherSdk"
adapter_mopub_dir = "CriteoMoPubAdapter"

platform :ios do
  desc %(Run tests:
    - Check code formatting
    - Run Unit & Functional tests with retries
  )
  lane :test do
    format_check
    multi_scan(
      scheme: "CriteoPublisherSdk",
      try_count: 3, parallel_testrun_count: 2
    )
    scan(scheme: "CriteoMoPubAdapter")
  end

  desc %(Check code format)
  lane :format_check do
    run_clang_format(
      script_path: "tools/clang-format/run-clang-format.py",
      extensions: "h,m",
      paths: [project_dir, adapter_mopub_dir],
      executable: "tools/clang-format/clang-format",
    )
  end

  desc %(Format code)
  lane :format do
    files = []
    Dir.chdir("..") do
      files =
        Dir.glob("#{project_dir}/**/*.{h,m}") +
        Dir.glob("#{adapter_mopub_dir}/**/*.{h,m}")
    end

    clang_format(
      clang_format_path: "tools/clang-format/clang-format",
      inplace: true,
      style: "file",
      verbose: true,
      files: files,
    )
  end

  desc %(Set marketing version)
  lane :version_bump do |options|
    version = increment_version_number(
      version_number: options[:version],
      xcodeproj: "CriteoPublisherSdk/CriteoPublisherSdk.xcodeproj"
    )
    file_replace("CriteoPublisherSdk.podspec",
                 /(spec.version.*)".*"/, "\\1\"#{version}\"")
    file_replace("CriteoPublisherSdk/Sources/CRConstants.h",
                 /(SDK_VERSION.*)".*"/, "\\1\"#{version}\"")
  end

  desc %(Extract last version changelog)
  lane :last_changelog do
    changelog = File.open("../CHANGELOG.md").read
    last_changelog = changelog
        .split(/----*\n/)[1] # Get last version section
        .lines[2..-1].join   # Remove first line that contains version
        .strip!
    File.write('../last-changelog.md', last_changelog)
  end

  def file_replace(filename, regex, replace)
    filename = '../' + filename
    puts "üèî Replacing in #{filename} #{regex} with #{replace}"
    File.write(filename, File.open(filename).read.gsub(regex, replace))
  end
end
