# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

project_dir = "CriteoPublisherSdk"
ad_viewer_dir = "CriteoAdViewer"
adapter_google_dir = "CriteoGoogleAdapter"
adapter_mopub_dir = "CriteoMoPubAdapter"

platform :ios do
  desc %(Run tests: Run Unit & Functional tests with retries)
  lane :test do
    scan(scheme: "CriteoAdViewer")
    scan(scheme: "CriteoGoogleAdapter")
    scan(scheme: "CriteoMoPubAdapter")
    multi_scan(
      scheme: "CriteoPublisherSdk",
      try_count: 5, parallel_testrun_count: 2,
    )
  end

  desc %(Check code format)
  lane :format_check do
    run_clang_format(
      script_path: "tools/clang-format/run-clang-format.py",
      extensions: "h,m",
      paths: [project_dir, ad_viewer_dir, adapter_google_dir, adapter_mopub_dir],
      executable: "tools/clang-format/clang-format",
    )
  end

  desc %(Format code)
  lane :format do
    files = Dir.chdir("..") do
      Dir.glob("#{project_dir}/**/*.{h,m}") +
      Dir.glob("#{ad_viewer_dir}/**/*.{h,m}") +
      Dir.glob("#{adapter_google_dir}/**/*.{h,m}") +
      Dir.glob("#{adapter_mopub_dir}/**/*.{h,m}")
    end

    clang_format(
      clang_format_path: "tools/clang-format/clang-format",
      inplace: true,
      style: "file",
      verbose: true,
      files: files,
    )
  end

  desc %(Set marketing version)
  lane :version_bump do |options|
    version = increment_version_number(
      version_number: options[:version],
      xcodeproj: "CriteoPublisherSdk/CriteoPublisherSdk.xcodeproj",
    )
    increment_version_number(
      version_number: version,
      xcodeproj: "CriteoGoogleAdapter/CriteoGoogleAdapter.xcodeproj",
    )
    increment_version_number(
      version_number: version,
      xcodeproj: "CriteoMoPubAdapter/CriteoMoPubAdapter.xcodeproj",
    )
    file_replace("CriteoPublisherSdk.podspec",
                 /(spec.version.*)".*"/, "\\1\"#{version}\"")
    file_replace("CriteoPublisherSdk/Sources/CRConstants.h",
                 /(SDK_VERSION.*)".*"/, "\\1\"#{version}\"")
  end

  desc %(Generates Debug & Release frameworks zip archives)
  lane :archive do
    Dir.chdir("..") do
      sh("scripts/archive.sh")
    end
  end

  lane :github_release do |options|
    version = options[:version]
    assets = Dir.chdir("..") do
      Dir.glob("build/output/*.zip")
    end
    changelog = last_changelog rescue ""
    puts "üèî [GitHub] Releasing #{version}\nChangelog:\n#{changelog}\nAssets: #{assets}..."
    set_github_release(
      repository_name: "criteo/ios-publisher-sdk",
      name: version,
      tag_name: version,
      description: changelog,
      is_draft: true,
      is_prerelease: version.include?("-"),
      upload_assets: assets,
    )
  end

  desc %(Archive then release version to GitHub)
  lane :release_github do |options|
    if ref = options[:ref]
      # Only supports semver refs such refs/tags/x.y.z-rc1
      options[:version] = ref.split("/").last
    end
    github_release(options)
  end

  desc %(Release version to CocoaPods)
  lane :release_cocoapods do
    pod_push
  end

  def last_changelog
    File.open("../CHANGELOG.md").read
        .split(/----*\n/)[1] # Get last version section
        .lines[2..-1].join # Remove first line that contains version
        .strip!
  end

  def file_replace(filename, regex, replace)
    filename = "../" + filename
    puts "üèî Replacing in #{filename} #{regex} with #{replace}"
    File.write(filename, File.open(filename).read.gsub(regex, replace))
  end
end
